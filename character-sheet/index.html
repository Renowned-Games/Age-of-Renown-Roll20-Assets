<div class="details">
	<div class="name">
		<label>
			<span>Character Name</span>
			<input type="text" name="attr_character_name" />
		</label>
	</div>
	<div class="option race">
		<label>
			<span>Race</span>
			<select name="attr_Race">
				<option value="human" selected>Human</option>
				<option value="dwarf">Dwarf</option>
				<option value="elf">Elf</option>
				<option value="halfling">Halfling</option>
			</select>
		</label>
	</div>
	<div class="option background">
		<label>
			<span>Background</span>
			<select name="attr_Background">
				<option value="soldier" selected>Soldier</option>
				<option value="thief">Thief</option>
				<option value="priest">Priest</option>
				<option value="mage">Mage</option>
			</select>
		</label>
	</div>
</div>
<hr />
<div class="progression">
	<div class="level">
		<label>
			<span>Level</span>
			<input type="number" name="attr_Level" min="1" max="10" step="1" value="1" />
		</label>
	</div>
	<div class="renown">
		<label>
			<span>Renown Rank</span>
			<input type="number" name="attr_RenownRank" min="0" max="5" step="1" value="0" />
		</label>
	</div>
	<div class="points">
		<div><span name="attr_TotalAbilityPoints"></span> ability points</div>
		<div><span name="attr_TotalPhysicalSkillPoints"></span> physical skill points</div>
		<div><span name="attr_TotalMentalSkillPoints"></span> mental skill points</div>
	</div>
</div>
<hr />
<div class="attributes">
	<div class="attribute">
		<label class="score">
			<span>Strength</span>
			<input type="number" name="attr_Strength" min="3" max="10" step="1" value="4" />
		</label>
		<div class="info target"><span name="attr_StrengthTarget"></span>+</div>
		<div class="info die">d<span name="attr_StrengthDie"></span></div>
	</div>
	<div class="attribute">
		<label class="score">
			<span>Agility</span>
			<input type="number" name="attr_Agility" min="3" max="10" step="1" value="4" />
		</label>
		<div class="info target"><span name="attr_AgilityTarget"></span>+</div>
		<div class="info die">d<span name="attr_AgilityDie"></span></div>
	</div>
	<div class="attribute">
		<label class="score">
			<span>Acuity</span>
			<input type="number" name="attr_Acuity" min="3" max="10" step="1" value="4" />
		</label>
		<div class="info target"><span name="attr_AcuityTarget"></span>+</div>
		<div class="info die">d<span name="attr_AcuityDie"></span></div>
	</div>
	<div class="attribute">
		<label class="score">
			<span>Cognition</span>
			<input type="number" name="attr_Cognition" min="3" max="10" step="1" value="4" />
		</label>
		<div class="info target"><span name="attr_CognitionTarget"></span>+</div>
		<div class="info die">d<span name="attr_CognitionDie"></span></div>
	</div>
	<div class="attribute">
		<label class="score">
			<span>Willpower</span>
			<input type="number" name="attr_Willpower" min="3" max="10" step="1" value="4" />
		</label>
		<div class="info target"><span name="attr_WillpowerTarget"></span>+</div>
		<div class="info die">d<span name="attr_WillpowerDie"></span></div>
	</div>
	<div class="attribute">
		<label class="score">
			<span>Spirit</span>
			<input type="number" name="attr_Spirit" min="3" max="10" step="1" value="4" />
		</label>
		<div class="info target"><span name="attr_SpiritTarget"></span>+</div>
		<div class="info die">d<span name="attr_SpiritDie"></span></div>
	</div>
	<div class="buy">
		<div class="cost">Cost: <span name="attr_AttributeBuyCost"></span> attribute buy points</div>
	</div>
</div>
<hr />
<div class="scores">
	<div class="body">Body: <span name="attr_Body"></span></div>
	<div class="mind">Mind: <span name="attr_Mind"></span></div>
	<div class="max-hp">Max HP: <span name="attr_MaxHP"></span></div>
	<div class="max-ap">Max AP: <span name="attr_MaxAP"></span></div>
	<div class="max-essence">Max Essence: <span name="attr_MaxEssence"></span></div>
</div>
<hr />
<div class="abilities">
	<div class="ability">
		<label class="score">
			<span>Martial</span>
			<input type="number" name="attr_MartialRanks" min="0" max="3" step="1" value="0" />
		</label>
	</div>
	<div class="ability">
		<label class="score">
			<span>Magic</span>
			<input type="number" name="attr_MagicRanks" min="0" max="3" step="1" value="0" />
		</label>
	</div>
	<div class="ability">
		<label class="score">
			<span>Physical Defense</span>
			<input type="number" name="attr_PhysicalDefenseRanks" min="0" max="3" step="1" value="0" />
		</label>
	</div>
	<div class="ability">
		<label class="score">
			<span>Mental Defense</span>
			<input type="number" name="attr_MentalDefenseRanks" min="0" max="3" step="1" value="0" />
		</label>
	</div>
	<div class="buy">
		<div class="cost">Cost: <span name="attr_AbilityPointCost"></span> ability points</div>
	</div>
</div>


<script type="text/worker">


	// Sheet attribute settings
	const attributeNames = ['Strength', 'Agility', 'Acuity', 'Cognition', 'Willpower', 'Spirit'];
	const abilityNames = ['MartialRanks', 'MagicRanks', 'PhysicalDefenseRanks', 'MentalDefenseRanks'];

	// Progression settings
	const MIN_LEVEL = 1;
	const MAX_LEVEL = 10;

	// Stat settings
	const MAX_HP_PER_BODY = 2;
	const MAX_HP_PER_RENOWN = 2;
	const MAX_AP_BASE = 5;


	/**
	 * Utility methods
	 */

	// Apply an increasing value over a progression
	function increasingProgression(to, increaseBy = 1, increaseEvery = 1) {
		let result = 0, value = 0;
		for (let i = 0; i <= to; ++i) {
			if (i && (i - 1) % increaseEvery == 0) value += increaseBy;
			result += value;
		}
		return result;
	}

	// Perform linear interpolation between two values
	function interpolateLinear(v1, v2, t) {
		return v1 + (v2 - v1) * t;
	}


	/**
	 * Creation & progression
	 */

	// Get total ability points by renown rank
	function getTotalAbilityPoints(renownRank) {
		return increasingProgression(renownRank + 1) - 1;
	}

	// Get total skill points by level & attribute score
	function getTotalSkillPoints(level, attributeScore) {
		return Math.round(interpolateLinear(
			attributeScore,
			attributeScore * 3,
			(level - MIN_LEVEL) / (MAX_LEVEL - MIN_LEVEL)
		));
	}

	// Get the buy cost for an attribute score
	function getAttributeBuyCost(attributeScore) {
		return increasingProgression(attributeScore - 3, 1, 2) - 1;
	}

	// Get the total attribute buy cost
	function getTotalAttributeBuyCost(attrs) {
		let cost = 0;
		attributeNames.forEach((attributeName) => {
			cost += getAttributeBuyCost(parseInt(attrs[attributeName]));
		});
		return cost;
	}

	// Get the ability point cost for an ability score
	function getAbilityPointCost(abilityRanks) {
		return increasingProgression(abilityRanks);
	}

	// Get the total ability point cost
	function getTotalAbilityPointCost(attrs) {
		let cost = 0;
		abilityNames.forEach((abilityName) => {
			cost += getAbilityPointCost(parseInt(attrs[abilityName]));
		});
		return cost;
	}


	/**
	 * Attributes
	 */

	// Get an attribute name from lowercase version
	function getAttributeName(name) {
		return name.charAt(0).toUpperCase() + name.substr(1).toLowerCase();
	}

	// Get the confirmation target for an attribute score
	function getAttributeConfirmationTarget(attributeScore) {
		switch (attributeScore) {
			case 1: return 9;
			case 2: return 8;
			case 3: return 8;
			case 4: return 7;
			case 5: return 6;
			case 6: return 5;
			case 7: return 4;
			case 8: return 4;
			case 9: return 3;
			case 10: return 3;
			case 11: return 2;
			case 12: return 2;
			case 13: return 2;
		}
	}

	// Get the die size for an attribute score
	function getAttributeDieSize(attributeScore) {
		switch (attributeScore) {
			case 1: return 2;
			case 2: return 2;
			case 3: return 2;
			case 4: return 3;
			case 5: return 4;
			case 6: return 6;
			case 7: return 8;
			case 8: return 8;
			case 9: return 10;
			case 10: return 10;
			case 11: return 12;
			case 12: return 12;
			case 13: return 12;
		}
	}

	// Get calculated fields for an attribute
	function getAttributeCalculatedFields(attribute, value) {
		fields = {};
		fields[attribute + 'Target'] = getAttributeConfirmationTarget(value);
		fields[attribute + 'Die'] = getAttributeDieSize(value);
		return fields;
	}


	/**
	 * Scores
	 */

	// Get a composite attribute score
	function getCompositeAttributeScore(attributes) {
		attributes = attributes.sort((a, b) => (a - b)).slice(1);
		return Math.floor((attributes[0] + attributes[1]) / 2);
	}

	// Get max HP
	function getMaxHP(strength, body, renown) {
		return strength + MAX_HP_PER_BODY * body + MAX_HP_PER_RENOWN * renown;
	}

	// Get max AP
	function getMaxAP(agility) {
		return MAX_AP_BASE + agility;
	}

	// Get max essence
	function getMaxEssence(spirit, renown) {
		return spirit + renown;
	}


	/**
	 * Sheet
	 */

	// Update all calculated fields on sheet open
	on('sheet:opened', (e) => {
		getAttrs([
			'Level', 'RenownRank',
			'Strength', 'Agility', 'Acuity', 'Cognition', 'Willpower', 'Spirit',
			'MartialRanks', 'MagicRanks', 'PhysicalDefenseRanks', 'MentalDefenseRanks',
		], (attrs) => {
			let fields = {
				TotalAbilityPoints: getTotalAbilityPoints(parseInt(attrs.RenownRank)),
				TotalPhysicalSkillPoints: getTotalSkillPoints(parseInt(attrs.Level), parseInt(attrs.Acuity)),
				TotalMentalSkillPoints: getTotalSkillPoints(parseInt(attrs.Level), parseInt(attrs.Cognition)),
				AttributeBuyCost: getTotalAttributeBuyCost(attrs),
				Body: getCompositeAttributeScore([parseInt(attrs.Strength), parseInt(attrs.Agility), parseInt(attrs.Acuity)]),
				Mind: getCompositeAttributeScore([parseInt(attrs.Cognition), parseInt(attrs.Willpower), parseInt(attrs.Spirit)]),
				MaxHP: getMaxHP(parseInt(attrs.Strength), parseInt(attrs.Body), parseInt(attrs.RenownRank)),
				MaxAP: getMaxAP(parseInt(attrs.Agility)),
				MaxEssence: getMaxEssence(parseInt(attrs.Spirit), parseInt(attrs.RenownRank)),
				AbilityPointCost: getTotalAbilityPointCost(attrs),
			};
			attributeNames.forEach((attributeName) => {
				Object.assign(fields, getAttributeCalculatedFields(attributeName, parseInt(attrs[attributeName])));
			});
			setAttrs(fields);
		});
	});

	// Update total ability points on renown change
	on('change:renownrank', (e) => {
		setAttrs({TotalAbilityPoints: getTotalAbilityPoints(parseInt(e.newValue))});
	});

	// Update total skill points on level / skill attribute change
	on('change:level change:acuity change:cognition', (e) => {
		getAttrs(['Level', 'Acuity', 'Cognition'], (attrs) => {
			setAttrs({
				TotalPhysicalSkillPoints: getTotalSkillPoints(parseInt(attrs.Level), parseInt(attrs.Acuity)),
				TotalMentalSkillPoints: getTotalSkillPoints(parseInt(attrs.Level), parseInt(attrs.Cognition)),
			});
		});
	});

	// Update calculated attribute fields on attribute change
	on('change:strength change:agility change:acuity change:cognition change:willpower change:spirit', (e) => {
		getAttrs(attributeNames, (attrs) => {
			let fields = {
				AttributeBuyCost: getTotalAttributeBuyCost(attrs),
				Body: getCompositeAttributeScore([parseInt(attrs.Strength), parseInt(attrs.Agility), parseInt(attrs.Acuity)]),
				Mind: getCompositeAttributeScore([parseInt(attrs.Cognition), parseInt(attrs.Willpower), parseInt(attrs.Spirit)]),
			};
			Object.assign(fields, getAttributeCalculatedFields(getAttributeName(e.sourceAttribute), parseInt(e.newValue)));
			setAttrs(fields);
		});
	});

	// Update max HP on attribute / renown change
	on('change:strength change:body change:renownrank', (e) => {
		getAttrs(['Strength', 'Body', 'RenownRank'], (attrs) => {
			setAttrs({MaxHP: getMaxHP(parseInt(attrs.Strength), parseInt(attrs.Body), parseInt(attrs.RenownRank))});
		});
	});

	// Update max AP on agility change
	on('change:agility', (e) => {
		setAttrs({MaxAP: getMaxAP(parseInt(e.newValue))});
	});

	// Update max essence on attribute / renown change
	on('change:spirit change:renownrank', (e) => {
		getAttrs(['Spirit', 'RenownRank'], (attrs) => {
			setAttrs({MaxEssence: getMaxEssence(parseInt(attrs.Spirit), parseInt(attrs.RenownRank))});
		});
	});

	// Update ability point cost on ability ranks change
	on('change:martialranks change:magicranks change:physicaldefenseranks change:mentaldefenseranks', (e) => {
		getAttrs(abilityNames, (attrs) => {
			setAttrs({AbilityPointCost: getTotalAbilityPointCost(attrs)});
		});
	});


</script>
